<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Builder - AI Data Analytics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .nav-btn {
            display: inline-block;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            border-radius: 8px;
            transition: all 0.3s;
            text-align: center;
        }
        .nav-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        .builder-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        .section-title {
            font-size: 1.5em;
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
            font-size: 14px;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 15px;
            transition: border 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        .chart-builder {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .chart-inputs {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: end;
            margin-bottom: 20px;
        }
        .chart-list {
            min-height: 60px;
        }
        .chart-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s;
        }
        .chart-item:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }
        .chart-info {
            flex: 1;
        }
        .chart-type {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        .chart-details {
            color: #666;
            font-size: 0.9em;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-add {
            background: #667eea;
            color: white;
        }
        .btn-add:hover {
            background: #5568d3;
        }
        .btn-remove {
            background: #ff4444;
            color: white;
            padding: 8px 15px;
            font-size: 14px;
        }
        .btn-remove:hover {
            background: #cc0000;
        }
        .btn-create {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 100%;
            padding: 15px;
            font-size: 18px;
            margin-top: 20px;
        }
        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        .btn-create:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .success {
            background: #4CAF50;
            color: white;
        }
        .error {
            background: #ff4444;
            color: white;
        }
        .info {
            background: #2196F3;
            color: white;
        }
        .empty-state {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dashboard-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .dashboard-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3em;
        }
        .dashboard-card p {
            color: #666;
            font-size: 0.95em;
            margin-bottom: 10px;
        }
        .dashboard-meta {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            font-size: 0.9em;
            color: #999;
        }
        .dashboard-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn-view {
            flex: 1;
            background: #667eea;
            color: white;
            padding: 10px;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
        }
        .btn-view:hover {
            background: #5568d3;
        }
        .btn-delete {
            background: #ff4444;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn-delete:hover {
            background: #cc0000;
        }
        .counter {
            background: #667eea;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="nav-buttons">
            <a href="chart_viewer.html" class="nav-btn">üìä Charts</a>
            <a href="insights_viewer.html" class="nav-btn">ü§ñ AI Insights</a>
            <a href="dashboard_builder.html" class="nav-btn" style="background: rgba(255,255,255,0.4);">üìà Dashboards</a>
        </div>
        
        <h1>üìà Dashboard Builder</h1>
        
        <div id="messageContainer"></div>
        
        <!-- Create New Dashboard -->
        <div class="builder-card">
            <div class="section-title">Create New Dashboard</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="dashboardName">Dashboard Name *</label>
                    <input type="text" id="dashboardName" placeholder="e.g., Sales Overview Q1 2024" required>
                </div>
                
                <div class="form-group">
                    <label for="datasetId">Dataset ID *</label>
                    <input type="number" id="datasetId" value="1" min="1" required>
                </div>
            </div>
            
            <div class="form-group">
                <label for="dashboardDesc">Description (optional)</label>
                <textarea id="dashboardDesc" placeholder="Brief description of this dashboard..." rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label for="layout">Layout Style</label>
                <select id="layout">
                    <option value="grid">Grid (Auto-arrange)</option>
                    <option value="2x2">2√ó2 Grid</option>
                    <option value="3x1">3 Columns</option>
                    <option value="1x3">3 Rows</option>
                </select>
            </div>
            
            <!-- Chart Builder -->
            <div class="chart-builder">
                <div class="section-title" style="font-size: 1.2em; margin-bottom: 15px;">
                    Add Charts <span class="counter" id="chartCount">0 added</span>
                </div>
                
                <div class="chart-inputs">
                    <div>
                        <label for="chartType">Chart Type</label>
                        <select id="chartType" onchange="updateInputFields()">
                            <option value="bar">Bar Chart</option>
                            <option value="horizontal_bar">Horizontal Bar</option>
                            <option value="pie">Pie Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="area">Area Chart</option>
                            <option value="box">Box Plot</option>
                            <option value="violin">Violin Plot</option>
                            <option value="grouped_bar">Grouped Bar Chart</option>
                            <option value="stacked_bar">Stacked Bar Chart</option>
                        </select>
                    </div>
                    
                    <div id="column1Group">
                        <label for="column1">Column</label>
                        <input type="text" id="column1" placeholder="e.g., City">
                    </div>
                    
                    <div id="column2Group" style="display: none;">
                        <label for="column2">Y-Column</label>
                        <input type="text" id="column2" placeholder="e.g., Sales">
                    </div>
                    
                    <div id="column3Group" style="display: none;">
                        <label for="column3">Group/Stack Column</label>
                        <input type="text" id="column3" placeholder="e.g., Department">
                    </div>
                    
                    <button onclick="addChartToList()" class="btn-add">+ Add Chart</button>
                </div>
                
                <div class="chart-list" id="chartList">
                    <div class="empty-state">No charts added yet. Add charts above to build your dashboard.</div>
                </div>
            </div>
            
            <button onclick="createDashboard()" class="btn-create" id="createBtn">
                Create Dashboard
            </button>
        </div>
        
        <!-- Saved Dashboards -->
        <div class="builder-card">
            <div class="section-title">Saved Dashboards</div>
            <div id="dashboardGrid" class="dashboard-grid">
                <div class="empty-state">Loading dashboards...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000/api';
        let chartConfigs = [];
        
        // Update input fields based on chart type
        function updateInputFields() {
            const type = document.getElementById('chartType').value;
            const col1 = document.getElementById('column1Group');
            const col2 = document.getElementById('column2Group');
            const col3 = document.getElementById('column3Group');
            
            if (type === 'line' || type === 'area') {
                col1.style.display = 'block';
                col2.style.display = 'block';
                col3.style.display = 'none';
                document.getElementById('column1').placeholder = 'X-axis (e.g., Month)';
                document.getElementById('column2').placeholder = 'Y-axis (e.g., Sales)';
            } else if (type === 'grouped_bar' || type === 'stacked_bar') {
                col1.style.display = 'block';
                col2.style.display = 'block';
                col3.style.display = 'block';
                document.getElementById('column1').placeholder = type === 'grouped_bar' ? 'Category (e.g., City)' : 'X-axis (e.g., Month)';
                document.getElementById('column2').placeholder = 'Value (e.g., Sales)';
                document.getElementById('column3').placeholder = type === 'grouped_bar' ? 'Group by (e.g., Region)' : 'Stack by (e.g., Product)';
            } else {
                col1.style.display = 'block';
                col2.style.display = 'none';
                col3.style.display = 'none';
                document.getElementById('column1').placeholder = 'e.g., City';
            }
        }
        
        // Add chart to list
        function addChartToList() {
            const type = document.getElementById('chartType').value;
            const col1 = document.getElementById('column1').value.trim();
            const col2 = document.getElementById('column2').value.trim();
            const col3 = document.getElementById('column3').value.trim();
            
            // Validation
            if (!col1) {
                showMessage('Please enter column name(s)', 'error');
                return;
            }
            
            if ((type === 'line' || type === 'area') && !col2) {
                showMessage('Please enter both X and Y columns', 'error');
                return;
            }
            
            if ((type === 'grouped_bar' || type === 'stacked_bar') && (!col2 || !col3)) {
                showMessage('Please enter all three columns', 'error');
                return;
            }
            
            // Build config
            const config = { type };
            
            if (type === 'line' || type === 'area') {
                config.x_column = col1;
                config.y_column = col2;
            } else if (type === 'grouped_bar') {
                config.category_column = col1;
                config.value_column = col2;
                config.group_column = col3;
            } else if (type === 'stacked_bar') {
                config.x_column = col1;
                config.y_column = col2;
                config.stack_column = col3;
            } else {
                config.column = col1;
            }
            
            chartConfigs.push(config);
            renderChartList();
            
            // Clear inputs
            document.getElementById('column1').value = '';
            document.getElementById('column2').value = '';
            document.getElementById('column3').value = '';
            
            showMessage('Chart added successfully!', 'success');
        }
        
        // Remove chart from list
        function removeChart(index) {
            chartConfigs.splice(index, 1);
            renderChartList();
            showMessage('Chart removed', 'info');
        }
        
        // Render chart list
        function renderChartList() {
            const container = document.getElementById('chartList');
            const counter = document.getElementById('chartCount');
            
            counter.textContent = `${chartConfigs.length} added`;
            
            if (chartConfigs.length === 0) {
                container.innerHTML = '<div class="empty-state">No charts added yet. Add charts above to build your dashboard.</div>';
                return;
            }
            
            const typeNames = {
                'bar': 'Bar Chart',
                'horizontal_bar': 'Horizontal Bar',
                'pie': 'Pie Chart',
                'line': 'Line Chart',
                'area': 'Area Chart',
                'box': 'Box Plot',
                'violin': 'Violin Plot',
                'grouped_bar': 'Grouped Bar Chart',
                'stacked_bar': 'Stacked Bar Chart'
            };
            
            container.innerHTML = chartConfigs.map((config, index) => {
                let details = '';
                if (config.column) {
                    details = `Column: ${config.column}`;
                } else if (config.x_column && config.y_column && !config.stack_column && !config.group_column) {
                    details = `X: ${config.x_column}, Y: ${config.y_column}`;
                } else if (config.category_column) {
                    details = `Category: ${config.category_column}, Value: ${config.value_column}, Group: ${config.group_column}`;
                } else if (config.stack_column) {
                    details = `X: ${config.x_column}, Y: ${config.y_column}, Stack: ${config.stack_column}`;
                } else {
                    details = 'Configuration set';
                }
                
                return `
                    <div class="chart-item">
                        <div class="chart-info">
                            <div class="chart-type">${typeNames[config.type] || config.type}</div>
                            <div class="chart-details">${details}</div>
                        </div>
                        <button onclick="removeChart(${index})" class="btn-remove">Remove</button>
                    </div>
                `;
            }).join('');
        }
        
        // Show message
        function showMessage(message, type) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="message ${type}">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 4000);
        }
        
        // Create dashboard
        async function createDashboard() {
            const name = document.getElementById('dashboardName').value.trim();
            const desc = document.getElementById('dashboardDesc').value.trim();
            const datasetId = parseInt(document.getElementById('datasetId').value);
            const layout = document.getElementById('layout').value;
            const btn = document.getElementById('createBtn');
            
            // Validation
            if (!name) {
                showMessage('Please enter a dashboard name', 'error');
                document.getElementById('dashboardName').focus();
                return;
            }
            
            if (!datasetId || datasetId < 1) {
                showMessage('Please enter a valid dataset ID', 'error');
                document.getElementById('datasetId').focus();
                return;
            }
            
            if (chartConfigs.length === 0) {
                showMessage('Please add at least one chart to the dashboard', 'error');
                return;
            }
            
            // Disable button
            btn.disabled = true;
            btn.textContent = 'Creating Dashboard...';
            
            try {
                const response = await fetch(`${API_BASE}/dashboards`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        description: desc || null,
                        dataset_id: datasetId,
                        chart_configs: chartConfigs,
                        layout: layout
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Failed to create dashboard');
                }
                
                showMessage(`Dashboard "${name}" created successfully! üéâ`, 'success');
                
                // Reset form
                document.getElementById('dashboardName').value = '';
                document.getElementById('dashboardDesc').value = '';
                chartConfigs = [];
                renderChartList();
                
                // Reload dashboards
                loadDashboards();
                
                // Scroll to saved dashboards
                setTimeout(() => {
                    document.getElementById('dashboardGrid').scrollIntoView({ behavior: 'smooth' });
                }, 500);
                
            } catch (error) {
                showMessage(`Error: ${error.message}`, 'error');
                console.error('Dashboard creation error:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Dashboard';
            }
        }
        
        // Load dashboards
        async function loadDashboards() {
            const container = document.getElementById('dashboardGrid');
            
            try {
                const response = await fetch(`${API_BASE}/dashboards`);
                const data = await response.json();
                
                if (data.count === 0) {
                    container.innerHTML = '<div class="empty-state">No dashboards created yet. Create your first dashboard above!</div>';
                    return;
                }
                
                container.innerHTML = data.dashboards.map(dash => `
                    <div class="dashboard-card">
                        <h3>${dash.name}</h3>
                        <p>${dash.description || 'No description provided'}</p>
                        <div class="dashboard-meta">
                            <span>üìä ${dash.chart_count} charts</span>
                            <span>üìê ${dash.layout}</span>
                        </div>
                        <p style="font-size: 0.85em; color: #999;">
                            Created: ${new Date(dash.created_at).toLocaleDateString()}
                        </p>
                        <div class="dashboard-actions">
                            <a href="dashboard_viewer.html?id=${dash.id}" class="btn-view">View Dashboard</a>
                            <button onclick="deleteDashboard(${dash.id}, '${dash.name}')" class="btn-delete">Delete</button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                container.innerHTML = '<div class="empty-state" style="color: #ff4444;">Failed to load dashboards</div>';
                console.error('Load dashboards error:', error);
            }
        }
        
        // Delete dashboard
        async function deleteDashboard(id, name) {
            if (!confirm(`Are you sure you want to delete "${name}"?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/dashboards/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage(`Dashboard "${name}" deleted successfully`, 'success');
                    loadDashboards();
                } else {
                    throw new Error('Failed to delete dashboard');
                }
            } catch (error) {
                showMessage('Failed to delete dashboard', 'error');
                console.error('Delete error:', error);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updateInputFields();
            loadDashboards();
        });
    </script>
</body>
</html>